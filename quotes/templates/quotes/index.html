{% extends 'quotes/base.html' %}

{% block content %}
    {% if quote %}
        <div id="randomQuote" class="quote-container">
            <article class="quote">
                <p class="text">{{ quote.text }}</p>
                <p class="meta">‚Äî {{ quote.source.name }} (–≤–µ—Å: {{ quote.weight }})</p>
                <p class="meta">
                    üëÅÔ∏è: {{ quote.views }} |
                    ‚ù§Ô∏è: <span id="likes">{{ quote.likes }}</span> |
                    üíî: <span id="dislikes">{{ quote.dislikes }}</span>
                </p>

                {% if user.is_authenticated %}
                    <form id="vote-form" method="post" action="{% url 'quotes:vote_quote' quote.pk %}">
                        {% csrf_token %}
                        <button type="button" data-action="like">‚ù§Ô∏è –õ–∞–π–∫</button>
                        <button type="button" data-action="dislike">üíî –î–∏–∑–ª–∞–π–∫</button>
                    </form>
                    <script>
                        const form = document.getElementById('vote-form');
                        const csrfToken = form.querySelector('input[name=csrfmiddlewaretoken]').value;

                        document.querySelectorAll('#vote-form button').forEach(btn => {
                            btn.addEventListener('click', function () {
                                const data = new FormData();
                                data.append('action', this.dataset.action);

                                fetch(form.action, {
                                    method: 'POST',
                                    headers: {
                                        'X-Requested-With': 'XMLHttpRequest',
                                        'X-CSRFToken': csrfToken
                                    },
                                    body: data
                                })
                                .then(r => r.json())
                                .then(j => {
                                    document.getElementById('likes').textContent = j.likes;
                                    document.getElementById('dislikes').textContent = j.dislikes;
                                });
                            });
                        });
                    </script>
                {% else %}
                    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="{% url 'login' %}">–≤–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫ –∏–ª–∏ –¥–∏–∑–ª–∞–π–∫.</p>
                {% endif %}
            </article>
        </div>

        
        <style>
            .quote-container { display: flex; flex-direction: column; gap: 15px; }
            .quote { opacity: 0; transform: translateY(10px); transition: all 0.5s ease; }
            .quote.show { opacity: 1; transform: translateY(0); }
        </style>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const quotes = document.querySelectorAll('#randomQuote .quote');
                quotes.forEach((quote, index) => {
                    setTimeout(() => {
                        quote.classList.add('show');
                    }, index * 150); // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                });
            });
        </script>

    {% else %}
        <p>–¶–∏—Ç–∞—Ç –µ—â—ë –Ω–µ—Ç. <a href="{% url 'quotes:add_quote' %}">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é</a>.</p>
    {% endif %}

    
{% endblock %}
