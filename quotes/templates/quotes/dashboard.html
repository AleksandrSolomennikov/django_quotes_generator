{% extends 'quotes/base.html' %}

{% block content %}
<h2>–î–∞—à–±–æ—Ä–¥</h2>
<p>–í—Å–µ–≥–æ —Ü–∏—Ç–∞—Ç: {{ total }}</p>
<p>–í—Å–µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: {{ total_sources }}</p>

<!-- –î—Ä–æ–ø–¥–∞—É–Ω —Å –∫–Ω–æ–ø–∫–æ–π -->
<div class="dropdown">
    <button id="filterBtn">
        –í—ã–±—Ä–∞—Ç—å —Ü–∏—Ç–∞—Ç—ã <span id="arrow">‚ñº</span>
    </button>
    <div id="dropdownMenu" class="dropdown-content">
        <a href="#" data-filter="latest">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–∏—Ç–∞—Ç—ã</a>
        <a href="#" data-filter="most_liked">–°–∞–º—ã–µ –∑–∞–ª–∞–π–∫–∞–Ω–Ω—ã–µ</a>
        <a href="#" data-filter="most_important">–°–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ (–ø–æ –≤–µ—Å—É)</a>
        <a href="#" data-filter="longest">–°–∞–º—ã–µ –¥–ª–∏–Ω–Ω—ã–µ</a>
        <a href="#" data-filter="shortest">–°–∞–º—ã–µ –∫–æ—Ä–æ—Ç–∫–∏–µ</a>
    </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ü–∏—Ç–∞—Ç -->
<div id="quotesContainer" class="quote-container">
    {% for q in latest %}
        <article class="quote">
            <p class="text">{{ q.text }}</p>
            <p class="meta">‚Äî {{ q.source.name }} ({{ q.created_at }})</p>
                <p class="meta">
                    üëÅÔ∏è: {{ q.views }} |
                    ‚ù§Ô∏è: <span id="likes-{{ q.pk }}">{{ q.likes }}</span> |
                    üíî: <span id="dislikes-{{ q.pk }}">{{ q.dislikes }}</span>
                </p>

                {% if user.is_authenticated %}
                    <form class="vote-form" data-quote-id="{{ q.pk }}" method="post" action="{% url 'quotes:vote_quote' q.pk %}">
                        {% csrf_token %}
                        <button type="button" data-action="like">‚ù§Ô∏è –õ–∞–π–∫</button>
                        <button type="button" data-action="dislike">üíî –î–∏–∑–ª–∞–π–∫</button>
                    </form>
                {% else %}
                    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="{% url 'login' %}">–≤–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫ –∏–ª–∏ –¥–∏–∑–ª–∞–π–∫.</p>
                {% endif %}
        </article>
    {% empty %}
        <p>–ù–µ—Ç —Ü–∏—Ç–∞—Ç</p>
    {% endfor %}
</div>

<style>
    /* –î—Ä–æ–ø–¥–∞—É–Ω */
    .dropdown { position: relative; display: inline-block; margin-bottom: 20px; }
    .dropdown-content { 
        position: absolute; 
        background-color: #f9f9f9; 
        min-width: 200px; 
        box-shadow: 0px 8px 16px rgba(0,0,0,0.2); 
        z-index: 1; 
        opacity: 0; 
        transform: translateY(-10px); 
        pointer-events: none;      /* –ß—Ç–æ–±—ã –∫–ª–∏–∫–∏ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏, –ø–æ–∫–∞ —Å–∫—Ä—ã—Ç */
        transition: all 0.3s ease;
    }
    .dropdown-content.show { 
        opacity: 1; 
        transform: translateY(0); 
        pointer-events: auto;      /* –î–µ–ª–∞–µ–º –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º */
    }

    .dropdown-content a { color: black; padding: 12px 16px; display: block; text-decoration: none; }
    .dropdown-content a:hover { background-color: #f1f1f1; }

    /* –°—Ç—Ä–µ–ª–∫–∞ */
    #arrow { display: inline-block; transition: transform 0.3s ease; }

    /* –¶–∏—Ç–∞—Ç—ã */
    .quote-container { display: flex; flex-direction: column; gap: 15px; }
    .quote { opacity: 0; transform: translateY(10px); transition: all 0.5s ease; }
    .quote.show { opacity: 1; transform: translateY(0); }
</style>

<script>
    const DASHBOARD_FILTER_URL = "{% url 'quotes:dashboard_filter' %}";
    const filterBtn = document.getElementById('filterBtn');
    const dropdownMenu = document.getElementById('dropdownMenu');
    const quotesContainer = document.getElementById('quotesContainer');
    const arrow = document.getElementById('arrow');

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –∏ –≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä–µ–ª–∫—É
    filterBtn.addEventListener('click', () => {
        dropdownMenu.classList.toggle('show');
        arrow.style.transform = dropdownMenu.classList.contains('show') ? 'rotate(180deg)' : 'rotate(0deg)';
    });


    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∏–ª—å—Ç—Ä–∞
    dropdownMenu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', async (e) => {
            e.preventDefault();
            const filter = link.getAttribute('data-filter');
            const response = await fetch(`${DASHBOARD_FILTER_URL}?filter=${filter}`);
            if (response.ok) {
                const html = await response.text();
                quotesContainer.innerHTML = html;

                // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Ü–∏—Ç–∞—Ç
                quotesContainer.querySelectorAll('.quote').forEach((q, i) => {
                    setTimeout(() => q.classList.add('show'), i * 100);
                });
            }

            dropdownMenu.classList.remove('show');
            arrow.style.transform = 'rotate(0deg)';
        });
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
    window.onclick = function(event) {
        if (!event.target.matches('#filterBtn') && !event.target.closest('.dropdown-content')) {
            dropdownMenu.classList.remove('show');
            arrow.style.transform = 'rotate(0deg)';
        }
    };

    // –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –Ω–∞—á–∞–ª—å–Ω—ã—Ö —Ü–∏—Ç–∞—Ç
    quotesContainer.querySelectorAll('.quote').forEach((q, i) => {
        setTimeout(() => q.classList.add('show'), i * 100);
    });

    // Event delegation for AJAX like/dislike
    quotesContainer.addEventListener('click', function(e) {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const form = btn.closest('.vote-form');
        if (!form) return;
        const quoteId = form.dataset.quoteId;
        const csrfToken = form.querySelector('input[name=csrfmiddlewaretoken]').value;
        const data = new FormData();
        data.append('action', btn.dataset.action);
        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            },
            body: data
        })
        .then(r => r.json())
        .then(j => {
            document.getElementById('likes-' + quoteId).textContent = j.likes;
            document.getElementById('dislikes-' + quoteId).textContent = j.dislikes;
        });
    });
</script>
{% endblock %}
