{% extends 'quotes/base.html' %}
{% block content %}
    <h2>–¢–æ–ø-10 —Ü–∏—Ç–∞—Ç –ø–æ –ª–∞–π–∫–∞–º</h2>
    <div id="topQuotes" class="quote-container">
        {% for q in top %}
        <article class="quote">
            <p class="text">‚Äú{{ q.text }}‚Äù</p>
                <p class="meta">‚Äî {{ q.source.name }} | üëÅÔ∏è: {{ q.views }} |
                    ‚ù§Ô∏è: <span id="likes-{{ q.pk }}">{{ q.likes }}</span> |
                    üíî: <span id="dislikes-{{ q.pk }}">{{ q.dislikes }}</span>
                </p>

                {% if user.is_authenticated %}
                    <form class="vote-form" data-quote-id="{{ q.pk }}" method="post" action="{% url 'quotes:vote_quote' q.pk %}">
                        {% csrf_token %}
                        <button type="button" data-action="like">‚ù§Ô∏è –õ–∞–π–∫</button>
                        <button type="button" data-action="dislike">üíî –î–∏–∑–ª–∞–π–∫</button>
                    </form>
                {% else %}
                    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="{% url 'login' %}">–≤–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫ –∏–ª–∏ –¥–∏–∑–ª–∞–π–∫.</p>
                {% endif %}
        </article>
        {% empty %}
            <p>–ü–æ–∫–∞ –Ω–µ—Ç —Ü–∏—Ç–∞—Ç.</p>
        {% endfor %}
    </div>

    <style>
        .quote-container { display: flex; flex-direction: column; gap: 15px; }
        .quote { opacity: 0; transform: translateY(10px); transition: all 0.5s ease; }
        .quote.show { opacity: 1; transform: translateY(0); }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const quotes = document.querySelectorAll('#topQuotes .quote');
            quotes.forEach((quote, index) => {
                setTimeout(() => {
                    quote.classList.add('show');
                }, index * 150);
            });

            // AJAX like/dislike for each quote
            document.querySelectorAll('.vote-form').forEach(form => {
                const quoteId = form.dataset.quoteId;
                const csrfToken = form.querySelector('input[name=csrfmiddlewaretoken]').value;
                form.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const data = new FormData();
                        data.append('action', this.dataset.action);
                        fetch(form.action, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRFToken': csrfToken
                            },
                            body: data
                        })
                        .then(r => r.json())
                        .then(j => {
                            document.getElementById('likes-' + quoteId).textContent = j.likes;
                            document.getElementById('dislikes-' + quoteId).textContent = j.dislikes;
                        });
                    });
                });
            });
        });
    </script>
{% endblock %}